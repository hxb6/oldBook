<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!-- 引入公共js和css -->
<head th:replace="/fragment/admin/head :: head">
</head>

<body>
<!-- 公共顶部  -->
<div th:replace="/fragment/admin/header :: header"></div>
<div class="container">
    <!--公共侧边栏-->
    <div th:replace="/fragment/admin/sidebar :: sidebar"></div>
    <!-- 内容-->
    <div class="content">
        <div class="content_head">
            <span>商家请求信息处理</span>
        </div>
        <!--用户申请成为商家处理信息-->
        <div class="table-overflow form-group informGoods">
            <table class="table media-table" id="table">
                <thead>
                <tr>
                </tr>
                </thead>
            </table>
        </div>
        <!-- 内容-->
    </div>
</div>


<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    申请人详细信息
                </h4>
            </div>
            <div class="modal-body">
                <!-- 下面div保存用户点击的一条申请信息中的id和申请人id以及 审批状态-默认为1 -->
                <div style="display: none">
                    <input type="hidden" id="applyId"/>
                    <input type="hidden" id="userId"/>
                    <input type="hidden" id="status" value="1"/>
                </div>
                <div class="input-group">
                    <span class="input-group-addon">用户姓名</span>
                    <input style="text-align: center;" disabled="disabled" class="form-control" id="userName"/>
                </div>
                <br/>
                <div class="input-group">
                    <span class="input-group-addon">用户账号</span>
                    <input style="text-align: center;" disabled="disabled" class="form-control" id="userAccount"/>
                </div>
                <br/>
                <div class="input-group">
                    <span class="input-group-addon">注册时间</span>
                    <input style="text-align: center;" disabled="disabled" class="form-control" id="userRegisterTime"/>
                </div>
                <br/>
                <div class="input-group">
                    <span class="input-group-addon">申请原因</span>
                    <input style="text-align: center;" disabled="disabled" class="form-control" id="applyReason"/>
                </div>
                <br/>
                <div class='radioGroup'>
                    <legend>审批结果</legend>
                    <input id='g1o1' name="group1" value="1" checked type="radio">
                    <label onclick="checkApplyStatus(1)" class="agree" for='g1o1'>同意</label>
                    <input id='g1o2' name="group1" value="2" type="radio">
                    <label onclick="checkApplyStatus(2)" class="refuse" for='g1o2'>拒绝</label>
                    <label class="common" style="color: red">拒绝理由:</label>
                    <input type="text" id="returnMessage" class="common returnMessage" maxlength="20"
                           placeholder="请填写拒绝理由,20字以内"/>
                </div>


            </div>
            <div class="modal-footer">
                <button type="button" onclick="dealApplyInfoAndUpdateUser()" class="btn btn-primary">
                    提交更改
                </button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
</body>
<!--申请处理维护-->
<script>
    /**
     * 当前页面导航栏颜色变深
     */
    $("#dealApply").addClass("activea");

    /**
     * 更新审批信息和用户信息
     */
    function dealApplyInfoAndUpdateUser() {
        $.ajax({
            url: "/admin/dealApplyInfoAndUpdateUser",
            type: "post",
            contentType: "application/json",
            data: JSON.stringify({
                "id": $("#applyId").val(),
                "status": $("#status").val(),
                "returnMessage": $("#returnMessage").val(),
                "userId": $("#userId").val()

            }),
            success: function () {
                //关闭Modal框刷新bootstrap table
                $("#myModal").modal("hide");
                $("#table").bootstrapTable("refresh");
            }
        });
    }

    /**
     * 检查单选按钮的值并设置审批状态
     * 选中同意按钮 隐藏拒绝理由框
     * 选中拒绝按钮 显示拒绝理由框
     */
    function checkApplyStatus(status) {
        //设置审批状态
        $("#status").val(status);
        status == 1 ? $(".common").hide() : $(".common").show();
    }

    /**
     * 得到申请人详细信息
     */
    function viewAndApply(applyId, userId, applyReason) {
        $("#applyId").val(applyId);
        $("#userId").val(userId);
        $("#applyReason").val(applyReason);
        $.ajax({
            url: "/admin/getUserById",
            type: "get",
            data: {
                "userId": userId
            },
            success: function (object) {
                if (object.status == 1) {
                    $("#userAccount").val(object.data.userAccount);
                    $("#userName").val(object.data.userName);
                    $("#userRegisterTime").val(object.data.userRegisterTime);
                    $("#myModal").modal("show");
                }
            }
        });
    }

    /**
     * 删除已审批的记录
     */
    function delApply(userId) {

    }

    /**
     * bootstrap table样式定义
     */
    var tableOrder = {
        url: "/admin/getAllApplyForBusiness",         //请求后台的URL（*）
        method: "get",                      //请求方式（*）
        toolbar: "#toolbar",                //工具按钮用哪个容器
        undefinedText: "未审批",            //当数据为 undefined 时显示的字符
        striped: true,                      //是否显示行间隔色
        cache: false,                       //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
        pagination: true,                   //是否显示分页（*）
        sidePagination: "server",           //分页方式 client客户端分页 server服务端分页
        sortable: false,                     //是否启用排序
        sortOrder: "asc",                   //排序方式
        pageNumber: 1,                       //初始化加载第一页，默认第一页
        pageSize: 10,                       //每页的记录条数（*）
        pageList: [10, 15, 20, 50],        //可供选择的每页的行数（*）
        search: true,                       //是否显示表格搜索，此搜索是客户端搜索，不会进服务端，所以，个人感觉意义不大
        strictSearch: true,
        showColumns: true,                  //是否显示所有的列
        showRefresh: true,                  //是否显示刷新按钮
        minimumCountColumns: 2,             //最少允许的列数
        clickToSelect: true,                //是否启用点击选中行
        height: 500,                        //行高，如果没有设置height属性，表格自动根据记录条数觉得表格高度
        uniqueId: "id",                     //每一行的唯一标识，一般为主键列
        showToggle: true,                    //是否显示详细视图和列表视图的切换按钮
        cardView: false,                    //是否显示详细视图
        detailView: false,                   //是否显示父子表
        columns: [
            {
                title: "序号",
                align: "center",
                formatter: function (value, row, index) {
                    return index + 1;
                },
            },
            {
                title: "申请人",
                align: "center",
                field: "applyPersonName"
            },
            {
                title: "申请原因",
                align: "center",
                field: "applyReason"
            },
            {
                title: "申请时间",
                align: "center",
                field: "applyTime"
            },
            {
                title: "审批时间",
                align: "center",
                field: "approvalTime"
            },
            {
                title: "审批状态",
                align: "center",
                formatter: function (value, row, index) {
                    return row.status == 0 ? "未审批" : "已审批";
                }
            },
            {
                title: '操作',
                align: "center",
                /**
                 * 如果申请未审批 管理员必须去审批 审批通过或不通过都可可以删除该记录 但不能再审批
                 * @param value
                 * @param row
                 * @param index
                 * @returns {string}
                 */
                formatter: function (value, row, index) {
                    var userId = row.userId;
                    var applyReason = row.applyReason;
                    var applyId = row.id;
                    var html1 = '<a title="审批" onclick="viewAndApply(' + applyId + ',' + userId + ',' + "'" + applyReason + "'" + ')"><span class="glyphicon glyphicon-edit" ></span></a>';
                    var html2 = '<a title="删除" onclick="delApply(' + userId + ')"><span class="glyphicon glyphicon-remove" ></span></a>';
                    return row.status == 0 ? html1 : html2;
                }
            },
        ]

    };
    $("#table").bootstrapTable(tableOrder);
</script>
</html>